capstone/
├─ init.sql
├─ db.php
├─ send_otp.php
├─ register.php
├─ verify_otp.php
├─ login.php
├─ logout.php
├─ profile.php
├─ edit_profile.php
├─ courses.php
├─ create_course.php
├─ edit_course.php
├─ delete_course.php
├─ ajax_search_courses.php
├─ admin/
│   └─ dashboard.php
├─ uploads/        (make writable)
└─ assets/
   ├─ style.css
   └─ scripts.js
2) Database schema — init.sql
Run this in phpMyAdmin or MySQL CLI:

sql
Copy code
CREATE DATABASE IF NOT EXISTS capstone_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE capstone_db;

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(150) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  fullname VARCHAR(150),
  role ENUM('user','admin') NOT NULL DEFAULT 'user',
  profile_pic VARCHAR(255) DEFAULT NULL,
  is_verified TINYINT(1) DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE otps (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_email VARCHAR(150) NOT NULL,
  otp VARCHAR(6) NOT NULL,
  expires_at DATETIME NOT NULL,
  type ENUM('register','login') NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE courses (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  slug VARCHAR(255) NOT NULL UNIQUE,
  description TEXT,
  price DECIMAL(10,2) DEFAULT 0.00,
  image VARCHAR(255) DEFAULT NULL,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE orders (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  total DECIMAL(10,2) NOT NULL,
  status ENUM('pending','processing','completed','cancelled') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB;
3) db.php — DB connection & helper
php
Copy code
<?php
// db.php
$DB_HOST = 'localhost';
$DB_USER = 'root';
$DB_PASS = '';
$DB_NAME = 'capstone_db';

$mysqli = new mysqli($DB_HOST, $DB_USER, $DB_PASS, $DB_NAME);
if ($mysqli->connect_errno) {
    die("Database connection failed: ".$mysqli->connect_error);
}
$mysqli->set_charset('utf8mb4');

function e($s){ return htmlspecialchars($s, ENT_QUOTES, 'UTF-8'); }
4) PHPMailer setup & OTP sender — send_otp.php
Install PHPMailer on your server (recommended): composer require phpmailer/phpmailer or download PHPMailer and include src/.

php
Copy code
<?php
// send_otp.php - helper to send OTP via email using PHPMailer
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require __DIR__ . '/vendor/autoload.php'; // adjust if you installed PHPMailer differently

function sendOtpEmail($toEmail, $otp) {
    $mail = new PHPMailer(true);
    try {
        // SMTP config - replace with your SMTP provider credentials
        $mail->isSMTP();
        $mail->Host = 'smtp.example.com';
        $mail->SMTPAuth = true;
        $mail->Username = 'you@example.com';
        $mail->Password = 'yourpassword';
        $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;
        $mail->Port = 587;

        $mail->setFrom('noreply@example.com', 'Capstone App');
        $mail->addAddress($toEmail);
        $mail->isHTML(true);
        $mail->Subject = 'Your OTP Code';
        $mail->Body = "<p>Your OTP code is: <strong>{$otp}</strong></p><p>It expires in 10 minutes.</p>";

        $mail->send();
        return true;
    } catch (Exception $e) {
        error_log("Mail error: " . $mail->ErrorInfo);
        return false;
    }
}
Replace SMTP host/username/password with your SMTP provider (Gmail SMTP requires app password & settings). For local dev you can also use mail() but PHPMailer is recommended.

5) register.php — registration that sends OTP
php
Copy code
<?php
// register.php
session_start();
require 'db.php';
require 'send_otp.php';

$errors = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username'] ?? '');
    $email = trim($_POST['email'] ?? '');
    $password = $_POST['password'] ?? '';
    $confirm = $_POST['confirm'] ?? '';

    if (strlen($username) < 4) $errors[] = "Username min 4 chars.";
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) $errors[] = "Invalid email.";
    if (strlen($password) < 6) $errors[] = "Password min 6 chars.";
    if ($password !== $confirm) $errors[] = "Passwords don't match.";

    if (!$errors) {
        // unique checks
        $stmt = $mysqli->prepare("SELECT id FROM users WHERE username=? OR email=? LIMIT 1");
        $stmt->bind_param('ss', $username, $email);
        $stmt->execute(); $stmt->store_result();
        if ($stmt->num_rows > 0) $errors[] = "Username or email already exists.";
        $stmt->close();
    }

    if (!$errors) {
        // create user as not verified
        $hash = password_hash($password, PASSWORD_DEFAULT);
        $stmt = $mysqli->prepare("INSERT INTO users (username,email,password) VALUES (?,?,?)");
        $stmt->bind_param('sss', $username, $email, $hash);
        if ($stmt->execute()) {
            // create OTP
            $otp = random_int(100000, 999999);
            $expires = (new DateTime('+10 minutes'))->format('Y-m-d H:i:s');
            $stmt->close();
            $stmt2 = $mysqli->prepare("INSERT INTO otps (user_email, otp, expires_at, type) VALUES (?,?,?, 'register')");
            $stmt2->bind_param('sss', $email, $otp, $expires);
            $stmt2->execute();
            $stmt2->close();

            // send email
            if (sendOtpEmail($email, $otp)) {
                $_SESSION['otp_email'] = $email;
                header('Location: verify_otp.php?type=register');
                exit;
            } else {
                $errors[] = "Failed to send verification email.";
            }
        } else {
            $errors[] = "DB error: " . $mysqli->error;
        }
    }
}
?>
<!doctype html><html><head><meta charset="utf-8"><title>Register</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="p-4">
<div class="container" style="max-width:520px;">
<h3>Create account</h3>
<?php foreach($errors as $err): ?><div class="alert alert-danger"><?= e($err) ?></div><?php endforeach; ?>
<form method="post">
  <input name="username" class="form-control mb-2" placeholder="Username" value="<?= e($_POST['username'] ?? '') ?>">
  <input name="email" class="form-control mb-2" placeholder="Email" value="<?= e($_POST['email'] ?? '') ?>">
  <input type="password" name="password" class="form-control mb-2" placeholder="Password">
  <input type="password" name="confirm" class="form-control mb-2" placeholder="Confirm">
  <button class="btn btn-primary">Register</button>
</form>
<p class="mt-2">Already? <a href="login.php">Login</a></p>
</div>
</body></html>
6) verify_otp.php — verify OTP for registration/login
php
Copy code
<?php
// verify_otp.php
session_start();
require 'db.php';
$type = $_GET['type'] ?? 'register'; // register or login
$email = $_SESSION['otp_email'] ?? '';

$errors = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $otp = trim($_POST['otp'] ?? '');
    if (!$email) $errors[] = "No email in session.";
    else {
        $stmt = $mysqli->prepare("SELECT id, otp, expires_at FROM otps WHERE user_email=? AND type=? ORDER BY id DESC LIMIT 1");
        $stmt->bind_param('ss', $email, $type);
        $stmt->execute(); $stmt->bind_result($id, $dbOtp, $expires_at);
        if ($stmt->fetch()) {
            $stmt->close();
            if (new DateTime() > new DateTime($expires_at)) {
                $errors[] = "OTP expired.";
            } elseif ($otp !== $dbOtp) {
                $errors[] = "Invalid OTP.";
            } else {
                // success
                if ($type === 'register') {
                    $stmt2 = $mysqli->prepare("UPDATE users SET is_verified=1 WHERE email=?");
                    $stmt2->bind_param('s', $email); $stmt2->execute(); $stmt2->close();
                    // cleanup OTP
                    $mysqli->query("DELETE FROM otps WHERE id = " . intval($id));
                    unset($_SESSION['otp_email']);
                    $_SESSION['success'] = "Verified. Please login.";
                    header('Location: login.php'); exit;
                } else { // login OTP
                    // find user and log in
                    $stmt3 = $mysqli->prepare("SELECT id,username,role FROM users WHERE email=? LIMIT 1");
                    $stmt3->bind_param('s',$email); $stmt3->execute(); $stmt3->bind_result($uid,$uname,$urole);
                    if ($stmt3->fetch()){
                        $_SESSION['user'] = ['id'=>$uid,'username'=>$uname,'email'=>$email,'role'=>$urole];
                        session_regenerate_id(true);
                        $stmt3->close();
                        $mysqli->query("DELETE FROM otps WHERE id = " . intval($id));
                        unset($_SESSION['otp_email']);
                        header('Location: profile.php'); exit;
                    } else {
                        $errors[] = "User not found.";
                    }
                }
            }
        } else {
            $errors[] = "No OTP found. Please request a new one.";
        }
    }
}
?>
<!doctype html><html><head><meta charset="utf-8"><title>Verify OTP</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="p-4">
<div class="container" style="max-width:420px;">
  <h3>Enter OTP</h3>
  <?php foreach($errors as $err): ?><div class="alert alert-danger"><?= e($err) ?></div><?php endforeach; ?>
  <form method="post">
    <input name="otp" class="form-control mb-2" placeholder="6-digit OTP">
    <button class="btn btn-primary">Verify</button>
  </form>
</div>
</body></html>
7) login.php — requests OTP for login
This login step asks for email, then creates an OTP and sends it for login (two-step auth via OTP).

php
Copy code
<?php
// login.php
session_start();
require 'db.php';
require 'send_otp.php';
$errors=[];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email = trim($_POST['email'] ?? '');
    $password = $_POST['password'] ?? '';

    if (filter_var($email, FILTER_VALIDATE_EMAIL) && $password) {
        // check password and is_verified
        $stmt = $mysqli->prepare("SELECT id, password, is_verified FROM users WHERE email=? LIMIT 1");
        $stmt->bind_param('s', $email);
        $stmt->execute(); $stmt->bind_result($id,$hash,$is_verified);
        if ($stmt->fetch()) {
            if (!password_verify($password, $hash)) {
                $errors[] = "Invalid credentials.";
            } elseif (!$is_verified) {
                $errors[] = "Account not verified. Check your email for OTP after registration.";
            } else {
                // create OTP and send for login (type=login)
                $otp = random_int(100000,999999);
                $expires = (new DateTime('+10 minutes'))->format('Y-m-d H:i:s');
                $stmt->close();
                $stmt2 = $mysqli->prepare("INSERT INTO otps (user_email, otp, expires_at, type) VALUES (?,?,?, 'login')");
                $stmt2->bind_param('sss', $email, $otp, $expires);
                $stmt2->execute(); $stmt2->close();
                if (sendOtpEmail($email, $otp)) {
                    $_SESSION['otp_email'] = $email;
                    header('Location: verify_otp.php?type=login');
                    exit;
                } else {
                    $errors[] = "Failed to send OTP.";
                }
            }
        } else {
            $errors[] = "Invalid credentials.";
        }
    } else $errors[] = "Enter valid email & password.";
}
?>
<!doctype html><html><head><meta charset="utf-8"><title>Login</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="p-4">
<div class="container" style="max-width:420px;">
  <h3>Login</h3>
  <?php if(!empty($_SESSION['success'])) { echo '<div class="alert alert-success">'. e($_SESSION['success']).'</div>'; unset($_SESSION['success']); } ?>
  <?php foreach($errors as $err): ?><div class="alert alert-danger"><?= e($err) ?></div><?php endforeach; ?>
  <form method="post">
    <input name="email" class="form-control mb-2" placeholder="Email" value="<?= e($_POST['email'] ?? '') ?>">
    <input type="password" name="password" class="form-control mb-2" placeholder="Password">
    <button class="btn btn-primary">Send OTP</button>
  </form>
  <p class="mt-2">No account? <a href="register.php">Register</a></p>
</div>
</body></html>
8) logout.php
php
Copy code
<?php
session_start();
$_SESSION = [];
if (ini_get("session.use_cookies")) setcookie(session_name(), '', time() - 42000);
session_destroy();
header('Location: login.php');
exit;
9) Profile & edit (with image upload)
profile.php:

php
Copy code
<?php
session_start();
require 'db.php';
if (empty($_SESSION['user'])) { header('Location: login.php'); exit; }
$uid = $_SESSION['user']['id'];
$stmt = $mysqli->prepare("SELECT username,email,fullname,profile_pic,role,created_at FROM users WHERE id=?");
$stmt->bind_param('i',$uid); $stmt->execute(); $stmt->bind_result($username,$email,$fullname,$profile_pic,$role,$created_at); $stmt->fetch(); $stmt->close();
?>
<!doctype html><html><head><meta charset="utf-8"><title>Profile</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="p-4">
<div class="container" style="max-width:720px;">
  <h3>Profile</h3>
  <?php if ($profile_pic): ?><img src="uploads/<?= e($profile_pic) ?>" style="max-width:150px;border-radius:8px;"><?php endif; ?>
  <p><strong>Username:</strong> <?= e($username) ?></p>
  <p><strong>Email:</strong> <?= e($email) ?></p>
  <p><strong>Full name:</strong> <?= e($fullname) ?></p>
  <p><strong>Role:</strong> <?= e($role) ?></p>
  <a href="edit_profile.php" class="btn btn-primary">Edit</a>
  <?php if($role==='admin'): ?><a href="admin/dashboard.php" class="btn btn-secondary">Admin</a><?php endif; ?>
  <a href="logout.php" class="btn btn-outline-danger">Logout</a>
</div>
</body></html>
edit_profile.php includes safe image upload logic (validate MIME, size, unique name) and updates DB.

10) Courses CRUD (example module)
courses.php (list + create link for admins):

php
Copy code
<?php
// courses.php - public listing with simple pagination
require 'db.php'; session_start();

$page = max(1,intval($_GET['page'] ?? 1));
$per = 6; $offset = ($page-1)*$per;

$stmt = $mysqli->prepare("SELECT SQL_CALC_FOUND_ROWS id,title,slug,description,price,image FROM courses ORDER BY created_at DESC LIMIT ?,?");
$stmt->bind_param('ii', $offset, $per);
$stmt->execute(); $res = $stmt->get_result(); $courses = $res->fetch_all(MYSQLI_ASSOC);
$stmt->close();
$totalRes = $mysqli->query("SELECT FOUND_ROWS() as total")->fetch_assoc(); $total = $totalRes['total']; $pages = ceil($total/$per);
?>
<!doctype html><html><head><meta charset="utf-8"><title>Courses</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="p-4">
<div class="container">
  <h3>Courses</h3>
  <?php if(!empty($_SESSION['user']) && $_SESSION['user']['role']==='admin'): ?>
    <a href="create_course.php" class="btn btn-primary mb-3">Create Course</a>
  <?php endif; ?>
  <div class="row">
    <?php foreach($courses as $c): ?>
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          <?php if($c['image']): ?><img src="uploads/<?= e($c['image']) ?>" class="card-img-top" style="height:160px;object-fit:cover;"><?php endif; ?>
          <div class="card-body d-flex flex-column">
            <h5><?= e($c['title']) ?></h5>
            <p class="mt-auto"><a href="course_view.php?slug=<?= e($c['slug']) ?>" class="btn btn-sm btn-primary">View</a></p>
          </div>
        </div>
      </div>
    <?php endforeach; ?>
  </div>

  <!-- pagination -->
  <nav><ul class="pagination">
    <?php for($i=1;$i<=$pages;$i++): ?>
      <li class="page-item <?= $i==$page ? 'active' : '' ?>"><a class="page-link" href="?page=<?= $i ?>"><?= $i ?></a></li>
    <?php endfor; ?>
  </ul></nav>
</div>
</body></html>
create_course.php follow the pattern shown earlier: form with file upload, prepared insert, generate slug.

edit_course.php & delete_course.php similar to admin product CRUD from previous message.

11) AJAX search endpoint — ajax_search_courses.php
php
Copy code
<?php
// ajax_search_courses.php
require 'db.php';
$q = trim($_GET['q'] ?? '');
if ($q === '') { echo json_encode([]); exit; }
$like = "%{$q}%";
$stmt = $mysqli->prepare("SELECT id,title,slug,price,image FROM courses WHERE title LIKE ? OR description LIKE ? LIMIT 10");
$stmt->bind_param('ss',$like,$like);
$stmt->execute(); $res = $stmt->get_result(); $arr = $res->fetch_all(MYSQLI_ASSOC);
echo json_encode($arr);
Frontend JS can call /ajax_search_courses.php?q=php and display results live.

12) Admin dashboard — admin/dashboard.php with Chart.js
php
Copy code
<?php
// admin/dashboard.php
session_start();
require '../db.php';
if (empty($_SESSION['user']) || $_SESSION['user']['role']!=='admin') { http_response_code(403); echo "Access denied"; exit; }

// get stats
$users = $mysqli->query("SELECT COUNT(*) as c FROM users")->fetch_assoc()['c'];
$courses = $mysqli->query("SELECT COUNT(*) as c FROM courses")->fetch_assoc()['c'];
$orders = $mysqli->query("SELECT COUNT(*) as c FROM orders")->fetch_assoc()['c'];
$revenue = $mysqli->query("SELECT IFNULL(SUM(total),0) as s FROM orders")->fetch_assoc()['s'];

// get monthly orders for chart (last 6 months)
$res = $mysqli->query("SELECT DATE_FORMAT(created_at,'%Y-%m') as ym, COUNT(*) as cnt, IFNULL(SUM(total),0) as rev
                       FROM orders
                       WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
                       GROUP BY ym ORDER BY ym ASC");
$months = []; $order_counts = []; $revenues = [];
while($r = $res->fetch_assoc()) { $months[] = $r['ym']; $order_counts[] = (int)$r['cnt']; $revenues[] = (float)$r['rev']; }
?>
<!doctype html><html><head><meta charset="utf-8"><title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">
<div class="container">
  <h3>Admin Dashboard</h3>
  <div class="row mb-3">
    <div class="col-md-3"><div class="card p-3"><h5>Users</h5><p><?= e($users) ?></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Courses</h5><p><?= e($courses) ?></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Orders</h5><p><?= e($orders) ?></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Revenue</h5><p>₦<?= number_format($revenue,2) ?></p></div></div>
  </div>

  <canvas id="ordersChart" height="80"></canvas>

  <script>
    const months = <?= json_encode($months) ?>;
    const counts = <?= json_encode($order_counts) ?>;
    const rev = <?= json_encode($revenues) ?>;

    const ctx = document.getElementById('ordersChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Orders',
          data: counts,
          tension: 0.3,
          yAxisID: 'A'
        },{
          label: 'Revenue',
          data: rev,
          tension: 0.3,
          yAxisID: 'B'
        }]
      },
      options: {
        scales: {
          A: { type: 'linear', position: 'left' },
          B: { type: 'linear', position: 'right' }
        }
      }
    });
  </script>
</div>
</body></html>
13) Minimal assets/style.css
css
Copy code
body { font-family: Inter, system-ui, sans-serif; background:#f7fafc; color:#111; }
.container { max-width:1100px; margin:auto; }
.card { border-radius:10px; box-shadow:0 4px 15px rgba(12,20,30,0.06); }
14) assets/scripts.js — example AJAX live search usage (frontend)
html
Copy code
<!-- include somewhere in header or page -->
<script>
function liveSearch(q) {
  if (q.length < 2) return;
  fetch('ajax_search_courses.php?q=' + encodeURIComponent(q))
    .then(r => r.json())
    .then(arr => {
      // render results into a container #searchResults
      const c = document.getElementById('searchResults');
      c.innerHTML = '';
      arr.forEach(item => {
        const el = document.createElement('div');
        el.innerHTML = `<a href="course_view.php?slug=${item.slug}">${item.title}</a>`;
        c.appendChild(el);
      });
    });
}
document.getElementById('searchInput')?.addEventListener('input', (e)=> liveSearch(e.target.value));
</script>
